---
title: "C++: macOS: LCOV 2.x: Ring buffer + Gtestã‚’å®Ÿè£…ã—ã¦ã¿ãŸè©±"
emoji: "ğŸ¦”"
type: "tech"
topics: ["cpp", "googletest", "lcov", "cmake", "macos"]
published: false
---

## 1. ã¯ã˜ã‚ã«

* è»¢è·æ´»å‹•ä¸­ã®ã‚ã‚‹ãƒ©ã‚¤ãƒ–ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã®è©¦é¨“ã§å¤§ã‚³ã‚±ã—ãŸãŠé¡Œã€ŒRing burfferã€ã€‚
* å½“æ™‚ã¯æ‚”ã—ã•ã§ã„ã£ã±ã„ã®æ€ã„ã‚’ã—ãŸãŠé¡Œã§ã‚‚ã‚ã‚‹ã®ã§ã€å®Œæˆåº¦ã‚’ä¸Šã’ãŸã„ã€‚
* ä»Šå›ã›ã£ã‹ããªã®ã§ã€ã‚«ãƒãƒ¬ãƒƒã‚¸ **100%** ã‚‚ã¿ãŸã„ã€åŸ·å¿µã®è¨˜éŒ²ã€‚

## 2. å®Ÿéš›ã®ã‚³ãƒ¼ãƒ‰

https://github.com/reina070707/tech-notes/tree/main/ring-buffer

## 3. ã“ã ã‚ã‚Šã®å®Ÿè£…ãƒã‚¤ãƒ³ãƒˆ

ãƒ­ãƒœãƒ†ã‚£ã‚¯ã‚¹ã®ç¾å ´ã«è€ãˆã†ã‚‹ã€Œå …ç‰¢ã•ã€ã€ãƒ¢ãƒ€ãƒ³C++ã®ã€ŒåŠ¹ç‡ã€ã‚’ä¸¡ç«‹ã•ã›ã‚‹ãŸã‚ã€ä»¥ä¸‹ã®ç‚¹ã‚’è€ƒæ…®ã€‚

* Header-only: ä¾å­˜é–¢ä¿‚ã‚’æœ€å°é™ã«ã—ã€å®¹æ˜“ã«ä»–ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¸çµ„ã¿è¾¼ã‚ã‚‹æ§‹æˆã€‚
* Thread-safe: `std::lock_guard`ã‚’ç”¨ã„ãŸ RAII çš„ãªæ’ä»–åˆ¶å¾¡ã‚’å¾¹åº•ã€‚ ã‚¹ãƒ¬ãƒƒãƒ‰å¢ƒç•Œã§ã‚‚ãƒ‡ãƒ¼ã‚¿ã®ä¸€è²«æ€§ã‚’ä¿è¨¼ã€‚
* Move Semantics: å‰å›ã®è¨˜äº‹ï¼ˆL-value / R-value ã®å¼•è¶Šã—ã®ä¾‹ãˆï¼‰ã‚’å®Ÿè·µã€‚
  * `std::forward`ã«ã‚ˆã‚‹å®Œå…¨è»¢é€ã€‚
  * `std::move` ã‚’æ´»ç”¨ã—ã€`std::unique_ptr` ã®ã‚ˆã†ãª move-only ãªå‹ã‚‚æ‰±ãˆã‚‹ã‚ˆã†ã«è¨­è¨ˆã€‚

https://zenn.dev/reinahirata07/articles/a43a0449f2657a

## 4. ãƒ†ã‚¹ãƒˆæˆ¦ç•¥ï¼šGoogleTest Ã— FetchContent

* sã€Œå‹•ãã¯ãšã€ã‚’ã€Œå‹•ã„ã¦ã„ã‚‹ã€ã¨æ–­è¨€ã™ã‚‹ãŸã‚ã«ã€GoogleTestã‚’å°å…¥ã€‚ ç’°å¢ƒã‚’æ±šã•ãªã„ã‚ˆã†cmakeã«FetchContentã‚’åˆ©ç”¨ã€‚

```cmake
include(FetchContent)
FetchContent_Declare(
  googletest
  URL https://github.com/google/googletest/archive/refs/heads/main.zip
)
set(gtest_force_shared_crt ON CACHE BOOL "" FORCE)
FetchContent_MakeAvailable(googletest)
```

* ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚‚ç¢ºèªã—ãŸã„ãŸã‚ã€cmakeã®projectã®ã™ãä¸‹ã‚ãŸã‚Šã«â†“ã‚’å…¥ã‚Œã‚‹ã€‚
```cmake
if(CMAKE_COMPILER_IS_GNUCXX OR CMAKE_CXX_COMPILER_ID MATCHES "Clang")
  add_compile_options(--coverage -O0 -g)
  add_link_options(--coverage)
endif()
```

* ã€Œæ­£å¸¸ç³»ã€ã ã‘ã§ãªãã€Œå®¹é‡0ã®ä¾‹å¤–ã€ãªã©ã®ã€Œç•°å¸¸ç³»ã€ã‚’ã©ã†å©ãã‹ã€‚

`EXPECT_THROW` / `EXPECT_NO_THROW` ã‚’åˆ©ç”¨ã€‚

```cpp
TEST(RingBufferTest, ConstructorThrow) {
    EXPECT_THROW({
        RingBuffer<int> rb(0);
    }, std::invalid_argument);
}

TEST(RingBufferTest, ConstructorNoThrow) {
    EXPECT_NO_THROW({
        RingBuffer<int> rb(10);
    });
}
```

## 5. macOSã§ã®LCOV 2.x ã‚¨ãƒ©ãƒ¼å›é¿

```
lcov --capture --directory . --output-file coverage.info
```
ã“ã‚Œã ã‘ã ã¨ã€ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹ã®ã§`--ignore-errors inconsistent,unsupported,category`ãƒ•ãƒ©ã‚°ãŒå¿…è¦ã€‚

ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿï¼:
```Bash
lcov: ERROR: (inconsistent) ... function ... end line less than start line.
```

## 6. çµæœï¼š100.0% ã®æ™¯è‰²

100%ã‚«ãƒãƒ¬ãƒƒã‚¸å®Œæˆï¼

![100%ã‚«ãƒãƒ¬ãƒƒã‚¸å®Œæˆï¼](/images/image_20260110.png)

## 7. ãŠã‚ã‚Š

ã“ã“ã¾ã§èª­ã‚“ã§ã„ãŸã ãã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚
